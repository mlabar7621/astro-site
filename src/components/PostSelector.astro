---
import { getCollection } from 'astro:content';
import { filterPosts } from '@components/utils.ts';
import type { BlogLocales } from '@i18n/locales';
import { ui_text } from '@i18n/ui';

const locale = Astro.currentLocale;
const blogLocale = `blog-${locale}`;
const ui = ui_text[locale as keyof typeof ui_text];

const allPosts = (await getCollection(blogLocale as BlogLocales));
const displayedPosts = filterPosts(allPosts);
const allTags = displayedPosts.map((tag: any) => tag.data.tag).flat();
const processedTags = allTags.reduce((acc: { [key: string]: number }, tag) => {
    //check if tag exists
    const value = acc[tag] || 0;
    return {
        ...acc,
        [tag]: value + 1
    }
}, {})

const { showCount } = Astro.props;
---

<span class="all-selectors">
    <div>
        <input type="search" id="search" placeholder=`${ui.blog.search}` />
    </div>
    <div>
        <span class="selector-wrapper">
            <p class="selector-title">{ui.blog.sort}:</p>
            <div class="selector" data-name="sorting-selector" tabindex="0">
                <div class="selector-button">
                    <p>Date</p>
                    <img class="dropdown-arrow" src="/astro-site/img/icons/angle-down-solid-full.svg">
                </div>
                <ul class="selector-content">
                    <li data-value="date">{ui.blog.date}</li>
                    <li data-value="rating">{ui.blog.rating}</li>
                </ul>
                <input type="hidden" class="selector-hidden" id="sort" value="date"/>
            </div>
        </span>
    </div>
    <div>
        <span class="selector-wrapper">
            <p class="selector-title">{ui.blog.tag_filter}:</p>
            <div class="selector" data-name="category-selector" tabindex="0">
                <div class="selector-button">
                    <p>{ui.blog.tag_select}</p>
                    <img class="dropdown-arrow" src="/astro-site/img/icons/angle-down-solid-full.svg">
                </div>
                <ul class="selector-content">
                    <li data-value="no-tag">{ui.blog.tag_select}</li>
                    {
                        Object.entries(processedTags).map(([key, val]) => (
                            <li data-value={key}>{key}{showCount ? ` (${val})` : ''}</li>
                        ))
                    }
                </ul>
                <input type="hidden" class="selector-hidden" id="tag" value="no-tag"/>
            </div>
        </span>
    </div>
</span>
<style>
    .selector-title {
        display: inline-block;
    }
    .selector-button {
        display: inline-flex;
    }
    .all-selectors {
        display: flex;
        justify-content: space-between;
    }
    .all-selectors div {
        vertical-align: top;
    }
    .selector {
        display: inline-block;
        position: relative;
    }
    .selector-content{
        opacity: 0;
        visibility: hidden;
        position: absolute;
        z-index: 100;
        background: rgb(var(--gray-x-light));
        gap: 0;
        margin-top: -1rem;
        transition: all 0.2s ease-in-out;
        transform: translateY(-8px);
		padding: 0 10px 10px;
		border-radius: 0 0 4px 4px;
        left: -10px;
        li {
            width: max-content;
            text-align: left;
            margin-bottom: 0.1rem;
        }
    }
    .dropdown-arrow {
		height: 1rem;
		bottom: -8px;
		position: relative;
	}
    .open .selector-content, .selector:hover .selector-content{
        opacity: 100;
        visibility: visible;
        transform: translateY(0px);
    }
    p{
        margin-top:0;
    }
    input {
        height: 2rem;
    }
</style>

<script>
    import { selectorDropdownScript } from '@components/dropdown.ts';
    selectorDropdownScript('.selector', '.selector-button p', '.selector-content li', '.selector-hidden');
</script>